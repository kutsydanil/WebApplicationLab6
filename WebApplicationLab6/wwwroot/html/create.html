<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Create</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../css/Style.css" rel="stylesheet">
</head>
<body>

    <div class="container">
        <div class="row">
            <div class="col-md-5">
                <h3>Добавление фильма</h3>
                <hr />
                <form name="createFilm">
                    <input type="hidden" name="id" value="0"/>
                    <div class="form-floating mb-2">
                        Название: <input asp-for="Name" class="form-control" name="name" />
                    </div>
                    <div class="form-floating mb-2">
                        Жанр: <select asp-for="GenreId" class="form-control" name="genre"></select>
                    </div>
                    <div class="form-floating mb-2">
                        Длительность: <input asp-for="Duration" class="form-control" name="duration" />
                    </div>
                    <div class="form-floating mb-3">
                        Компания-производитель: <select asp-for="FilmProductionId" class="form-control" name="filmProduction"></select>
                    </div>
                    <div class="form-floating mb-2">
                        Страна-производитель: <select asp-for="CountryProductionId" class="form-control" name="countryProduction"></select>
                    </div>
                    <div class="form-floating mb-2">
                        Возраст: <input asp-for="AgeLimit" class="form-control" name="ageLimit" />
                    </div>
                    <div class="form-floating mb-2">
                        Описание: <input asp-for="Description" class="form-control" name="description" />
                    </div>

                    <div class="form-floating">
                        <input type="submit" id="submit" value="Создать" class="btn btn-secondary" />
                        <a href="index.html" class="btn btn-primary">Вернуться назад</a>
                        <input type="reset" value="Сбросить" class="btn btn-primary">
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>

        //Функция получения всех жанров в элемент html-разметки (select)
        async function GetAllGenres() {
            var selectList = createFilm.genre;
			const response = await fetch("/api/genres", {
				method: "GET",
				headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
				const genres = await response.json();
				genres.forEach(genre => {
					var option = document.createElement("option");
					option.text = genre.name;
					option.value = parseInt(genre.id);
					selectList.append(option)
				});
            }
        }

		//Функция получения всех стран-производителей в элемент html-разметки (select)
		async function GetAllCountryProductions() {
			var selectList = createFilm.countryProduction;
			const response = await fetch("/api/countryProductions", {
				method: "GET",
				headers: { "Accept": "application/json" }
			});
			if (response.ok === true) {
				const countryProductions = await response.json();
				countryProductions.forEach(countryProduction => {
					var option = document.createElement("option");
					option.text = countryProduction.name;
					option.value = parseInt(countryProduction.id);
                    selectList.append(option);
				});
			}
        }

		//Функция получения всех компаний-производителей в элемент html-разметки (select)
		async function GetAllFilmProduction() {
			var selectList = createFilm.filmProduction;
			const response = await fetch("/api/filmProductions", {
				method: "GET",
				headers: { "Accept": "application/json" }
			});
			if (response.ok === true) {
				const filmsProductions = await response.json();
				filmsProductions.forEach(filmsProduction => {
					var option = document.createElement("option");
					option.text = filmsProduction.name;
					option.value = parseInt(filmsProduction.id);
                    selectList.append(option);
				});
			}
		}
        
        GetAllGenres();
        GetAllCountryProductions();
        GetAllFilmProduction();

        //Функция создания новой записи о фильме
		async function CreateFilm(name, genreId, duration, filmProductionId, countryProductionId, ageLimit, description) {
			const response = await fetch("/api/films", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({

                    name: name,
                    genreId: parseInt(genreId, 10),
                    duration: parseInt(duration, 10),
                    filmProductionId: parseInt(filmProductionId, 10),
                    countryProductionId: parseInt(countryProductionId, 10),
                    ageLimit: parseInt(ageLimit, 10),
					description: description

                })
            });
            if (response.ok === true) {
                const film = await response.json();
                alert("Запись была успешно создана");
            }
			else {
                alert("Ошибка в данных");
			}
        }

		document.forms["createFilm"].addEventListener("submit", e => {
			e.preventDefault();
            const form = document.forms["createFilm"];

			const name = form.elements["name"].value;
            
			const genreId = form.elements["genre"].value;
			const duration = form.elements["duration"].value;
            const filmProductionId = form.elements["filmProduction"].value;
            const countryProductionId = form.elements["countryProduction"].value;
			const ageLimit = form.elements["ageLimit"].value;
			const description = form.elements["description"].value;
			
			CreateFilm(name, genreId, duration, filmProductionId, countryProductionId, ageLimit, description);
		});
    </script>
</body>
</html>